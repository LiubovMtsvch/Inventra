@model CourseProjectitr.Models.Inventory
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity

@{
    var username = Context.Session.GetString("GitHubUser") ?? User.Identity?.Name ?? "Гость";
}

<h2 class="mb-4">Inventory: @Model.Title</h2>

<div class="scroll-table-wrapper">
<table class="table-clean table table-bordered table-striped table-hover align-middle text-start">

    <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Category</th>
            <th>Owner</th>
            <th>Public</th>
            <th>Created At</th>
            <th>Tags</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>@Model.NumberPrefix</td>
            <td>@Model.Title</td>
            <td class="wrap-text text-wrap">
                @Html.Raw(string.Join("\u200B", Model.Description.ToCharArray()))

            </td>

            <td>@Model.Category</td>
            <td class="wrap-text text-wrap">@Model.OwnerName</td>
            <td>@(Model.IsPublic ? "Yes" : "No")</td>
            <td>@Model.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
            <td class="wrap-text tag-cell">
                <div class="tag-container">
                    @foreach (var tag in Model.Tags)
                    {
                        <div class="wrap-text text-wrap">
                            <span class="tag-pill">@tag.Name</span>
                        </div>

                    }
                </div>
            </td>

        </tr>
    </tbody>
</table>
</div>

<div class="d-flex gap-2 mt-3">
    <a href="@Url.Action("Edit", "Inventory", new { ids = new[] { Model.Id } })" class="button-13">Edit</a>

    @if (User.Identity.IsAuthenticated && Model.IsPublic)
    {
        <a asp-action="AddItem" asp-controller="Inventory" asp-route-id="@Model.Id" class="button-13">Add item</a>
    }
    <button type="button" class="button-13" id="toggleAccessForm">Give access</button>
</div>

<div id="accessForm" class="mt-3" style="display: none;">
    <h4>Give acces to the user</h4>

    <form asp-controller="InventoryAccess" asp-action="GrantAccess" method="post">
        <input type="hidden" name="inventoryId" value="@Model.Id" />
        <input type="hidden" name="userIds" id="userIdsHidden" />



        <div class="mb-2">
     
            <input type="text" id="userSearch" class="form-control" placeholder="Enter user's name or email" />
        </div>

        <div class="form-check">
            <input type="checkbox" name="canEdit" class="form-check-input" id="canEdit" />
            <label class="form-check-label" for="canEdit">Can edit</label>
        </div>

        <div class="form-check">
            <input type="checkbox" name="canComment" class="form-check-input" id="canComment" />
            <label class="form-check-label" for="canComment">Can comment</label>
        </div>
        <button type="submit" class="button-13">Submit</button>
    </form>
</div>


<h3>Items</h3>

@if (Model.Items != null && Model.Items.Any())
{
    <table class="table-clean table table-bordered table-striped table-hover align-middle text-start">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Inventory Number</th>
                <th>Created At</th>
                <th>Created By</th>
                <th>Creator Email</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>@item.CustomId</td>
                    <td>
                        <a asp-action="EditItem" asp-controller="Inventory" asp-route-id="@item.Id" class="text-decoration-none">
                            @item.Title
                        </a>
                    </td>

                    <td>@item.InventoryNumber</td>
                    <td>@item.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                    <td>@item.CreatedBy</td>
                    <td>@item.CreatorEmail</td>
                </tr>
            }
        </tbody>
    </table>

}
else
{
    <p>No items found for this inventory.</p>
}

@if (TempData["AccessMessage"] != null)
{
    var type = TempData["AccessMessageType"]?.ToString();
    var color = type == "success" ? "#28a745" : "#dc3545"; 

    <p class="mt-2" style="color: @color;">@TempData["AccessMessage"]</p>
}

@section Scripts {
    <script>
        
        document.getElementById("toggleAccessForm").addEventListener("click", function () {
            const form = document.getElementById("accessForm");
            form.style.display = form.style.display === "none" ? "block" : "none";
        });

        const input = document.getElementById('userSearch');
        const tagify = new Tagify(input, {
            whitelist: [],
            maxTags: 10,
            enforceWhitelist: true,
            dropdown: {
                enabled: 1,
                position: "auto"
            }
        });

        tagify.on('input', function (e) {
            const query = e.detail.value.trim();
            const isEmail = query.includes("@@");

           fetch(`/api/users/search?query=${query}`)
                .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    tagify.settings.whitelist = data.map(user => ({
                            value: user.value, 
                            id: user.id,
                            name: user.name,
                            email: user.email
                    }));
                    tagify.dropdown.show.call(tagify, query);
                }
                });
        });

            tagify.on('add', function () {
            const ids = tagify.value.map(tag => tag.id);
            document.getElementById('userIdsHidden').value = JSON.stringify(ids);
        });


    </script>
}

